[Ubuntu note: the code in this package's version of heimdal is not
 exactly the same as the one being considered in the original 
 version of this patch. Function acceptor_start was changed by
 commit 4fb6a6adc9, and therefore, the block that is moved outside
 of the 'if(!first_ok)'  conditional in 7a19658c1 is not the same
 as the one in the original code for this version of heimdal (this 
 block being 'if (ctx->selected_mech_type == GSS_C_NO_OID)' block
 in the original patch). The chosen backport strategy was to simply
 move the  'if' block as it is in this version of the code outside
 of the 'if(!first_ok)' conditional, which means, moving 
 'if (preferred_mech_type == GSS_C_NO_OID)' outside of 
 'if(!first_ok)'. That is because 'ctx->selected_mech_type' does
 not exist in this package's version of heimdal. It seems like
 'ctx->selected_mech_type' and 'advertised_mech' were variables
 created in 4fb6a6adc9 to "substitute" 'preferred_mech_type', so
 instructions where these are changed/checked were previously
 using 'preferred_mech_type' instead. Since
 'ctx->preferred_mech_type' (the variable that should be checked
 to avoid the vulnerability) in 'acceptor_start' for this package's
 version of the code is only ever assigned the value of
 'preferred_mech_type' when it is assigned a value, it makes sense
 that we continue checking this value in order to avoid the
 'ctx->preferred_mech_type' NULL pointer dereference.
 -- Camila Camargo de Matos <camila.camargodematos@canonical.com>]

Backport of:

From 7a19658c1f4fc4adf85bb7bea96caae5ba57b33e Mon Sep 17 00:00:00 2001
From: Nicolas Williams <nico@twosigma.com>
Date: Thu, 11 Nov 2021 22:38:46 -0600
Subject: [PATCH] spnego: Fix NULL deref
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reported to Heimdal by MichaÅ‚ KÄ™pieÅ„ <michal@isc.org>.

From the report:

Acknowledgement
---------------

This flaw was found while working on addressing ZDI-CAN-12302: ISC BIND
TKEY Query Heap-based Buffer Overflow Remote Code Execution
Vulnerability, which was reported to ISC by Trend Micro's Zero Day
Initiative.
---
 lib/gssapi/spnego/accept_sec_context.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

Index: heimdal-1.7~git20150920+dfsg/lib/gssapi/spnego/accept_sec_context.c
===================================================================
--- heimdal-1.7~git20150920+dfsg.orig/lib/gssapi/spnego/accept_sec_context.c
+++ heimdal-1.7~git20150920+dfsg/lib/gssapi/spnego/accept_sec_context.c
@@ -605,7 +605,7 @@ acceptor_start
      * If opportunistic token failed, lets try the other mechs.
      */
 
-    if (!first_ok && ni->mechToken != NULL) {
+    if (!first_ok) {
 	size_t j;
 
 	preferred_mech_type = GSS_C_NO_OID;
@@ -619,15 +619,16 @@ acceptor_start
 	    if (ret == 0)
 		break;
 	}
-	if (preferred_mech_type == GSS_C_NO_OID) {
-	    HEIMDAL_MUTEX_unlock(&ctx->ctx_id_mutex);
-	    free_NegotiationToken(&nt);
-	    return ret;
-	}
 
 	ctx->preferred_mech_type = preferred_mech_type;
     }
 
+    if (preferred_mech_type == GSS_C_NO_OID) {
+	HEIMDAL_MUTEX_unlock(&ctx->ctx_id_mutex);
+       free_NegotiationToken(&nt);
+       return ret;
+    }
+
     /*
      * The initial token always have a response
      */
