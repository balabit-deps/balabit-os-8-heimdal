[Ubuntu note: function _kdc_set_e_text, used in the original patch,
 does not exist in Heimdal in Xenial's version, and therefore, an
 alternative had to be used. Samba's patch, available at
 https://gitlab.com/samba-team/samba/-/commit/
 0cb4b939f192376bf5e33637863a91a20f74c5a5, uses
 krb5_set_error_message, while upstream seems to recommend use of
 kdc_log, as seen in
 https://bugzilla.samba.org/show_bug.cgi?id=14770#c9. For this
 reason, the backport of this patch was structured in the below
 manner: uses both kdc_log, as recommended by upstream and 
 krb5_set_error_message, since the also recommended 
 _kdc_audit_addreason does not seem to be available in Xenial.
 -- Camila Camargo de Matos <camila.camargodematos@canonical.com>]

Backport of:

From 04171147948d0a3636bc6374181926f0fb2ec83a Mon Sep 17 00:00:00 2001
From: Luke Howard <lukeh@padl.com>
Date: Fri, 27 Aug 2021 11:42:48 +1000
Subject: [PATCH] kdc: validate sname in TGS-REQ

In tgs_build_reply(), validate the server name in the TGS-REQ is present before
dereferencing.
---
 kdc/krb5tgs.c | 4 ++++
 1 file changed, 4 insertions(+)

Index: heimdal-7.7.0+dfsg/kdc/krb5tgs.c
===================================================================
--- heimdal-7.7.0+dfsg.orig/kdc/krb5tgs.c
+++ heimdal-7.7.0+dfsg/kdc/krb5tgs.c
@@ -1660,6 +1660,11 @@ tgs_build_reply(krb5_context context,
 
 	s = &adtkt.cname;
 	r = adtkt.crealm;
+    } else if (s == NULL) {
+	ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;
+	krb5_set_error_message(context, ret, "No server in request");
+	kdc_log(context, config, 0, "No server in request");
+	goto out;
     }
 
     _krb5_principalname2krb5_principal(context, &sp, *s, r);
